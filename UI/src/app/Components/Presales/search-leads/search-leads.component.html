<!-- <div class="lead-header">Manage Leads</div> -->
<div class="button-row">
  <div style="padding-bottom: 8px; padding-top: 6px">
    <div class="leads-update">
      <div class="title-div">
        <span class="lead-header">SEARCH LEAD</span>
      </div>
    </div>
  </div>

  <div
    style="margin-bottom: 0rem"
    class="search-main-div"
    [formGroup]="formData"
  >
    <div class="search-container">
      <mat-form-field
        style="width: 250px"
        class="search-class"
        appearance="outline"
      >
        <mat-label>Project</mat-label>
        <input
          type="text"
          matInput
          [value]="
            selectedProject.projectName ? selectedProject.projectName : ''
          "
          (input)="searchProject($event)"
          [formControl]="project"
          [matAutocomplete]="projectAuto"
          [disabled]="projectId > 0"
        />
        <mat-autocomplete
          #projectAuto="matAutocomplete"
          (optionSelected)="onProjectSelect($event)"
          [displayWith]="displayProject"
        >
          <mat-option *ngFor="let option of projects" [value]="option">
            {{ option.projectName }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>
      <mat-form-field
        appearance="outline"
        class="mat-20 pt-20 ml-2"
        style="width: 100px"
      >
        <mat-label>Country</mat-label>
        <input
          type="text"
          matInput
          [(ngModel)]="selectedCountry"
          (input)="searchCountry($event)"
          [matAutocomplete]="countryAuto"
          formControlName="countryCode"
        />
        <mat-autocomplete
          #countryAuto="matAutocomplete"
          [displayWith]="displayCountryFn"
          (optionSelected)="onCountrySelect($event)"
        >
          <mat-option *ngFor="let option of filteredCountries" [value]="option">
            {{ option.commonRefValue }}
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>

      <mat-form-field
        appearance="outline"
        class="search-class"
        style="width: 250px; margin-left: 5px"
      >
        <mat-label>Phone No</mat-label>
        <input
          matInput
          (input)="onSearch($any($event).target?.value)"
          placeholder="Enter Phone No"
          formControlName="phoneNumber"
        />
      </mat-form-field>
      <button
        class="ml-2"
        mat-raised-button
        color="primary"
        (click)="onClickSearchButton()"
        type="button"
      >
        SEARCH
      </button>
      <mat-icon
        matTooltip="Clear Filters"
        (click)="resetInput()"
        class="clear-filter"
        >filter_list_off</mat-icon
      >
    </div>
    <div class="buttons">
      <button
        mat-raised-button
        color="primary"
        (click)="onCpWalkInButtonClick()"
        type="button"
        *ngIf="isDisplayAddCpWalkIn"
      >
        ADD AS A CP-WALK-IN
      </button>
      <button
        *ngIf="!isLeadsFound || isDisplayAddCpWalkIn"
        mat-icon-button
        (click)="onAddNewLeadButtonClick()"
        matTooltip="Add Lead"
      >
        <i class="bi bi-sign-intersection-fill"></i>
      </button>
    </div>
  </div>
</div>

<mat-card class="leads-cmn-card">
  <mat-card-content class="leads-cmn-card-content">
    <div class="tab-head">
      <table
        matSort
        mat-table
        [dataSource]="this.allLeads"
        class="mat-elevation-z8"
      >
        <ng-container matColumnDef="rowNumber">
          <th mat-header-cell *matHeaderCellDef>#</th>
          <td mat-cell *matCellDef="let i = index">
            {{ pageIndex * pageSize + i + 1 }}
          </td>
        </ng-container>
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>Customer Name</th>
          <td mat-cell *matCellDef="let lead">
            <!-- Display Name -->
            <div [ngClass]="{ bold: lead.starCount >= 1 }">
              <!-- {{ lead.name }} -->
              <span
                class="remarks-short"
                matTooltip="{{ lead.name?.length ? lead.name : '' }}"
              >
                {{
                  lead.name
                    ? lead.name?.length > 10
                      ? (lead.name | slice : 0 : 10) + "..."
                      : lead.name
                    : "N/A"
                }}
              </span>
            </div>

            <!-- Display Stars if getStarCount(lead) > 0
            <div
              *ngIf="getStarCount(lead) > 0 && isDisplayStars()"
              class="star-container"
            >
              <div
                *ngFor="let star of [].constructor(getStarCount(lead))"
                class="star"
                (click)="
                  onDialogOpen(lead.phoneNumber); $event.stopPropagation()
                "
                [ngStyle]="{ color: getStarColor(lead.projectName) }"
              >
                <mat-icon class="star-icon">grade</mat-icon>
              </div>
            </div> -->
          </td>
        </ng-container>
        <ng-container matColumnDef="phoneNumber">
          <th mat-header-cell *matHeaderCellDef>Phone Number</th>
          <td mat-cell *matCellDef="let lead">{{ lead.phoneNumber }}</td>
        </ng-container>
        <ng-container matColumnDef="projectName">
          <th mat-header-cell *matHeaderCellDef>Project</th>
          <td mat-cell *matCellDef="let lead">{{ lead.projectName }}</td>
        </ng-container>
        <ng-container matColumnDef="sourceName">
          <th mat-header-cell *matHeaderCellDef>Source</th>
          <td mat-cell *matCellDef="let lead">{{ lead.sourceName }}</td>
        </ng-container>
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Current Status</th>
          <td mat-cell *matCellDef="let lead">
            {{
              (lead.isAcquiredLead == null ||
                lead.isAcquiredLead == undefined) &&
              isCP
                ? "N/A"
                : lead.status
            }}
          </td>
        </ng-container>

        <ng-container matColumnDef="createdDate">
          <th mat-header-cell *matHeaderCellDef>Created Date</th>
          <td
            mat-cell
            *matCellDef="let lead"
            matTooltip="{{ lead.createdDate | date : 'medium' }}"
          >
            {{ lead.createdDate | date : "mediumDate" }}
          </td>
        </ng-container>
        <ng-container matColumnDef="assignedToSaleDate">
          <th mat-header-cell *matHeaderCellDef>Assigned To Sales On</th>
          <td
            mat-cell
            *matCellDef="let lead"
            matTooltip="{{ lead.assignedToSaleDate | date : 'medium' }}"
          >
            {{
              lead.assignedToSaleDate
                ? (lead.assignedToSaleDate | date : "mediumDate")
                : "N/A"
            }}
          </td>
        </ng-container>
        <ng-container matColumnDef="remarks">
          <th mat-header-cell *matHeaderCellDef>Remarks</th>
          <td mat-cell *matCellDef="let lead" (click)="goToGreForm(lead.id)">
            <span
              class="remarks-short"
              matTooltip="{{
                lead.remarks?.length ? lead.remarks : 'No remarks'
              }}"
            >
              {{
                lead.remarks?.length > 30
                  ? (lead.remarks | slice : 0 : 30) + "..."
                  : lead.remarks || "N/A"
              }}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="presalesMember">
          <th mat-header-cell *matHeaderCellDef>Presales</th>
          <td mat-cell *matCellDef="let lead">
            {{
              lead.assignedPresalesUserName == null
                ? "N/A"
                : lead.assignedPresalesUserName
            }}
          </td>
        </ng-container>
        <ng-container matColumnDef="salesMember">
          <th mat-header-cell *matHeaderCellDef>Sales</th>
          <td
            mat-cell
            *matCellDef="let lead"
            matTooltip="{{
              lead.assignedSalesUserName?.length
                ? lead.assignedSalesUserName
                : 'No Sales Person'
            }}"
          >
            <!-- Show 'NA' if assignedSalesUserName is null, otherwise show the name -->
            {{
              lead.assignedSalesUserName
                ? lead.assignedSalesUserName.length > 10
                  ? (lead.assignedSalesUserName | slice : 0 : 10) + "..."
                  : lead.assignedSalesUserName
                : "N/A"
            }}
          </td>
        </ng-container>

        <ng-container matColumnDef="opportunityId">
          <th mat-header-cell *matHeaderCellDef>Opportunity Id</th>
          <td mat-cell *matCellDef="let lead">{{ lead.opportunityId }}</td>
        </ng-container>

        <ng-container matColumnDef="mobileNumber">
          <th mat-header-cell *matHeaderCellDef>Mobile Number</th>
          <td mat-cell *matCellDef="let lead">{{ lead.phoneNumber }}</td>
        </ng-container>
        <ng-container matColumnDef="subSource">
          <th mat-header-cell *matHeaderCellDef>Sub Source</th>
          <td mat-cell *matCellDef="let lead">
            <ng-container>
              <!-- {{ lead.subSourceName }} -->
              <span
                class="remarks-short"
                matTooltip="{{
                  lead.subSourceName?.length ? lead.subSourceName : ''
                }}"
              >
                {{
                  lead.subSourceName
                    ? lead.subSourceName.length > 10
                      ? (lead.subSourceName | slice : 0 : 10) + "..."
                      : lead.subSourceName
                    : "N/A"
                }}
              </span>
            </ng-container>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let lead">
            <mat-icon
              matTooltip="Transfer lead"
              (click)="openLeadTransferDialog(lead.id)"
              class="font icon-spacing"
              >arrow_outward</mat-icon
            >
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>

        <tr
          class="table-row"
          mat-row
          *matRowDef="let lead of leads; columns: displayedColumns"
          (click)="isNotLastColumn($event) ? goToGreForm(lead.id) : null"
          [ngClass]="{ 'expired-color': lead.isExpired === 'Y' }"
        ></tr>
      </table>
    </div>
  </mat-card-content>
  <b>
    <hr style="margin: 0" />
  </b>
  <div class="leads-footer">
    <div>
      <mat-card-footer class="pagination-sec">
        <mat-paginator
          id="pageNumber"
          [length]="totalItems"
          [pageSize]="pageSize"
          [pageSizeOptions]="pageSizeOptions"
          (page)="onPageChange($event)"
          showFirstLastButtons
          class="custom-paginator"
        >
        </mat-paginator>
      </mat-card-footer>
    </div>
  </div>
</mat-card>

<div
  *ngIf="openDialog"
  class="modal fade show"
  tabindex="-1"
  style="display: block"
  aria-labelledby="audioModal"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h1 class="modal-title fs-5" id="audioModal" style="color: red">
            Lead Transfer
          </h1>
        </div>
        <button
          type="button"
          class="btn-close"
          aria-label="Close"
          (click)="onDialogClose()"
        ></button>
      </div>
      <div class="modal-body">
        <div>Select a source and subsource</div>
        <!-- First Row: Source, Sub Source -->
        <div
          class="first-row"
          style="display: flex; gap: 16px; align-items: flex-end"
        >
          <mat-form-field appearance="outline" class="mat-45">
            <mat-label>Source</mat-label>
            <mat-select (selectionChange)="onSelectSource($event.value)">
              <mat-option
                *ngFor="let item of sources"
                [value]="item.leadSourceId"
              >
                {{ item.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field
            class="example-full-width"
            class="mat-45"
            appearance="outline"
          >
            <mat-label>Sub Source</mat-label>
            <input
              type="text"
              matInput
              (input)="searchSubSource($event)"
              [formControl]="subSourceControl"
              [matAutocomplete]="subSourceAuto"
            />
            <mat-autocomplete
              #subSourceAuto="matAutocomplete"
              (optionSelected)="onSubSourceSelect($event)"
              [displayWith]="displaySubSource"
            >
              <mat-option *ngFor="let option of subSources" [value]="option">
                {{ option.name }}
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>
        </div>
        <!-- OK Button Row -->
        <div style="display: flex; justify-content: flex-end; margin-top: 16px">
          <button
            mat-flat-button
            color="primary"
            (click)="sendToApproval()"
            [disabled]="!sourceId || !subSourceControl.value"
          >
            Send to approval
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
