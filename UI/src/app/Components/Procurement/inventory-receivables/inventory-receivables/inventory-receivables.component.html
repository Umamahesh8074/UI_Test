<h4 class="ir-header">
  {{ isAdding ? "ADD INVENTORY RECEIVABLE" : "EDIT INVENTORY RECEIVABLE" }}
</h4>

<form [formGroup]="formData" (ngSubmit)="save()">
  <div class="example-container">
    <mat-card class="card" style="padding: 0">
      <mat-card-content class="cmn-mat-content mat-card-scroll">
        <div class="row form-section" style="padding: 10px 8px">
          <mat-form-field appearance="outline" class="ir-mat-100">
            <mat-label>Search/Select Purchase Order</mat-label>
            <input
              type="text"
              matInput
              [value]="selectedPo.poCode ? selectedPo.poCode : ''"
              (input)="searchPurchaseOrder($event)"
              [formControl]="purchaseOrderFc"
              [matAutocomplete]="purchaseOrderAuto"
            />
            <mat-autocomplete
              #purchaseOrderAuto="matAutocomplete"
              (optionSelected)="onPurchaseOrderSelect($event)"
              [displayWith]="displayPurchaseOrder"
            >
              <mat-option *ngFor="let po of purchaseOrder" [value]="po">
                {{ po.poCode }}
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>

          <mat-form-field appearance="outline" class="ir-mat-45">
            <mat-label> Invoice Number</mat-label>
            <input matInput formControlName="invoiceNumber" type="text" />
          </mat-form-field>

          <mat-form-field appearance="outline" class="ir-mat-45">
            <mat-label>Invoice Date</mat-label>
            <input
              matInput
              [matDatepicker]="irdobPicker"
              formControlName="invoiceDate"
            />
            <mat-datepicker-toggle
              matSuffix
              [for]="irdobPicker"
            ></mat-datepicker-toggle>
            <mat-datepicker #irdobPicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline" class="ir-mat-45">
            <mat-label> Invoice Amount</mat-label>
            <input matInput formControlName="invoiceAmount" type="number" />
          </mat-form-field>

          <mat-form-field appearance="outline" class="ir-mat-45">
            <mat-label>Select Receivable Status</mat-label>
            <mat-select
              formControlName="receivableStatus"
              (selectionChange)="receivableStatusChange($event)"
            >
              <mat-option
                *ngFor="let element of receivableStatus"
                [value]="element"
              >
                {{ element }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <!-- Item Table with Editable Fields -->
        <div class="row form-section" style="padding: 0 15px" *ngIf="poId">
          <table mat-table [dataSource]="inventoryReceivablesDto">
            <ng-container matColumnDef="itemCategory">
              <th mat-header-cell *matHeaderCellDef>Item Category</th>
              <td mat-cell *matCellDef="let row">
                {{ row.categoryName }}
              </td>
            </ng-container>

            <ng-container matColumnDef="itemSubCategory">
              <th mat-header-cell *matHeaderCellDef>Item Subcategory</th>
              <td mat-cell *matCellDef="let row">
                {{ row.itemSubCategoryName }}
              </td>
            </ng-container>

            <ng-container matColumnDef="itemUnit">
              <th mat-header-cell *matHeaderCellDef>Item Unit</th>
              <td mat-cell *matCellDef="let row">
                {{ row.inventoryUnitName }}
              </td>
            </ng-container>

            <ng-container matColumnDef="itemSpecifications">
              <th mat-header-cell *matHeaderCellDef>Item Specifications</th>
              <td mat-cell *matCellDef="let row">
                {{ row.itemSpecificationsName }}
              </td>
            </ng-container>

            <ng-container matColumnDef="quantity">
              <th mat-header-cell *matHeaderCellDef>Quantity</th>
              <td mat-cell *matCellDef="let row">
                {{ row.quantity }}
              </td>
            </ng-container>

            <!-- <ng-container matColumnDef="quantityReceived">
              <th mat-header-cell *matHeaderCellDef>Present Qty Received</th>
              <td mat-cell *matCellDef="let row; let i = index">
                <input
                  matInput
                  type="number"
                  [formControl]="quantities[i].get('quantityReceived')"
                  (input)="checkQuantity(row, i)"
                />
                <div
                  *ngIf="quantityRecivedCheck[i] === false"
                  class="inline-error"
                >
                  Quantity exceeds limit
                </div>
                <div *ngIf="leastOneQuantity" class="inline-error">
                  Enter atleast one
                </div>
              </td>
            </ng-container> -->

            <ng-container matColumnDef="quantityReceived">
              <th mat-header-cell *matHeaderCellDef>Present Qty Received</th>
              <td mat-cell *matCellDef="let row; let i = index">
                <ng-container
                  *ngIf="
                    row.quantity !== row.totalQuantityReceived;
                    else fullyReceived
                  "
                >
                  <input
                    matInput
                    type="number"
                    [formControl]="quantities[i].get('quantityReceived')"
                    (input)="checkQuantity(row, i)"
                  />
                  <div
                    *ngIf="quantityRecivedCheck[i] === false"
                    class="inline-error"
                  >
                    Quantity exceeds limit
                  </div>
                  <div *ngIf="leastOneQuantity" class="inline-error">
                    Enter at least one
                  </div>
                </ng-container>

                <ng-template #fullyReceived>
                  <span style="color: green; font-weight: bold"
                    >FULLY RECEIVED</span
                  >
                </ng-template>
              </td>
            </ng-container>
            <!-- 
            <ng-container matColumnDef="quantityExceeded">
              <th mat-header-cell *matHeaderCellDef>Qty Exceed</th>
              <td mat-cell *matCellDef="let row; let i = index">
                <input
                  matInput
                  type="number"
                  [formControl]="quantities[i].get('quantityExceeded')"
                />
              </td>
            </ng-container> -->

            <ng-container matColumnDef="quantityExceeded">
              <th mat-header-cell *matHeaderCellDef>Qty Exceed</th>
              <td mat-cell *matCellDef="let row; let i = index">
                <ng-container
                  *ngIf="
                    row.quantity !== row.totalQuantityReceived;
                    else fullyReceivedExceed
                  "
                >
                  <input
                    matInput
                    type="number"
                    [formControl]="quantities[i].get('quantityExceeded')"
                  />
                </ng-container>

                <ng-template #fullyReceivedExceed>
                  <span class="text-muted">{{
                    row.totalQuantityExceed ?? 0
                  }}</span>
                </ng-template>
              </td>
            </ng-container>

            <ng-container matColumnDef="totalPendingQuantity">
              <th mat-header-cell *matHeaderCellDef>Pending Qty</th>
              <td mat-cell *matCellDef="let row">
                {{ row.totalPendingQuantity ?? 0 }}
              </td>
            </ng-container>

            <ng-container matColumnDef="previousQuantityReceived">
              <th mat-header-cell *matHeaderCellDef>Qty Received Till Now</th>
              <td mat-cell *matCellDef="let row">
                {{ row.totalQuantityReceived ?? 0 }}
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>
          <mat-card-footer>
            <mat-paginator
              [length]="totalItems"
              [pageSize]="pageSize"
              [pageSizeOptions]="pageSizeOptions"
              (page)="onPageChange($event)"
              showFirstLastButtons
            ></mat-paginator>
          </mat-card-footer>
        </div>

        <!-- Add the Received By field below the table -->
        <div class="row form-section" style="padding: 10px 8px">
          <mat-form-field class="ir-mat-45" appearance="outline">
            <mat-label>Search/Select Received By</mat-label>
            <input
              type="text"
              matInput
              [value]="selectedUser.userName ? selectedUser.userName : ''"
              (input)="searchUser($event)"
              [formControl]="userFc"
              [matAutocomplete]="userAuto"
            />
            <mat-autocomplete
              #userAuto="matAutocomplete"
              (optionSelected)="onUserSelect($event)"
              [displayWith]="displayUser"
            >
              <mat-option *ngFor="let option of users" [value]="option">
                {{ option.userName }}
              </mat-option>
            </mat-autocomplete>
            <mat-error *ngIf="userFc.hasError('required')">
              Select Incharge
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="ir-mat-45">
            <mat-label>Received Date</mat-label>
            <input
              matInput
              [matDatepicker]="dobPicker"
              formControlName="receivedDate"
            />
            <mat-datepicker-toggle
              matSuffix
              [for]="dobPicker"
            ></mat-datepicker-toggle>
            <mat-datepicker #dobPicker></mat-datepicker>
          </mat-form-field>
        </div>

        <!-- Submit and Reset Buttons -->
        <mat-card-footer class="add-mat-card-footer">
          <div>
            <button
              mat-flat-button
              class="btn-class accent"
              (click)="gotoInventoryReceivables()"
              type="button"
            >
              BACK
            </button>
            <button
              *ngIf="isAdding"
              mat-flat-button
              class="btn-class warn"
              (click)="clearForm()"
              type="button"
            >
              RESET
            </button>
            <button mat-flat-button class="btn-class primary" type="submit">
              {{ isAdding ? "ADD" : "UPDATE" }}
            </button>
          </div>
        </mat-card-footer>
      </mat-card-content>
    </mat-card>
  </div>
</form>
