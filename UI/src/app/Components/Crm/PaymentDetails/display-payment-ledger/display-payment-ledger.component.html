<div class="pac-header">
  <div class="center">PAYMENT LEDGER</div>
  <div class="right">
    <button
      mat-flat-button
      style="color: white; background-color: #004869"
      (click)="addCustomerPayment()"
      class="btn-class primary"
    >
      <mat-icon class="font">add</mat-icon> ADD
    </button>
  </div>
  <div class="right">
    <button
      mat-flat-button
      class="btn-class-home"
      id="goBack"
      style="background-color: rgb(97, 97, 38); color: white; width: 8rem"
      (click)="goBack()"
    >
      Go To Home
    </button>
  </div>
</div>
<div class="example-button-row">
  <div class="search-container">
    <mat-form-field appearance="outline" class="search-class ml-2">
      <mat-label>Search On Customer Name</mat-label>
      <input
        matInput
        (input)="onSearch($any($event).target?.value)"
        placeholder="Enter Customer Name"
      />
    </mat-form-field>
    <mat-form-field appearance="outline" class="search-class ml-2">
      <input
        type="text"
        placeholder="Select Projects"
        aria-label="Select projects"
        matInput
        [matAutocomplete]="projectAuto"
        [formControl]="project"
        (input)="searchProject($event)"
      />
    </mat-form-field>

    <mat-autocomplete #projectAuto="matAutocomplete">
      <mat-option>
        <mat-checkbox
          #allProjectSelected
          (click)="onAllSelectProject()"
          [checked]="isProjectAllSelected()"
          >All</mat-checkbox
        ></mat-option
      >
      <mat-option
        *ngFor="let umproject of userManageprojects"
        (click)="$event.preventDefault()"
      >
        <div (click)="$event.stopPropagation()">
          <mat-checkbox
            [checked]="isSelectedProject(umproject.projectId, umproject.id)"
            (change)="onProjectSelect(umproject, $event)"
            (click)="$event.stopPropagation()"
          >
            {{ umproject.projectName }}
          </mat-checkbox>
        </div>
      </mat-option>
    </mat-autocomplete>
    <button
      mat-icon-button
      matSuffix
      (click)="onProjectSelectButtonClick()"
      type="button"
      style="margin-left: -2px"
    >
      <mat-icon>search</mat-icon>
    </button>
    <!-- BLOCK -->
    <mat-form-field appearance="outline" class="search-class ml-2">
      <input
        type="text"
        placeholder="Select Block"
        aria-label="Select Blocks"
        matInput
        [matAutocomplete]="blockAuto"
        [formControl]="block"
        (input)="searchBlock($event)"
      />
    </mat-form-field>

    <mat-autocomplete #blockAuto="matAutocomplete">
      <mat-option>
        <mat-checkbox
          #allBlockSelected
          (click)="onAllSelectBlock()"
          [checked]="isBlockAllSelected()"
          >All</mat-checkbox
        ></mat-option
      >
      <mat-option
        *ngFor="let block of blocks"
        (click)="$event.preventDefault()"
      >
        <div (click)="$event.stopPropagation()">
          <mat-checkbox
            [checked]="isSelectedBlock(block.id)"
            (change)="onBlockSelect(block, $event)"
            (click)="$event.stopPropagation()"
          >
            {{ block.name + " ( " + block.projectCode + " )" }}
          </mat-checkbox>
        </div>
      </mat-option>
    </mat-autocomplete>
    <button
      mat-icon-button
      matSuffix
      (click)="onBlockSelectButtonClick()"
      type="button"
      style="margin-left: -2px"
    >
      <mat-icon>search</mat-icon>
    </button>
    <mat-form-field appearance="outline" class="search-class ml-2">
      <mat-label>Search/Select Unit</mat-label>
      <input
        type="text"
        matInput
        (input)="searchUnit($event)"
        [formControl]="unit"
        [matAutocomplete]="unitAuto"
      />
      <mat-autocomplete
        #unitAuto="matAutocomplete"
        (optionSelected)="onUnitSelect($event)"
        [displayWith]="displayUnit"
      >
        <mat-option *ngFor="let option of units" [value]="option">
          {{ option.unitName }}
        </mat-option>
      </mat-autocomplete>
    </mat-form-field>
    <mat-form-field appearance="outline" class="search-class ml-2">
      <mat-label>Select Status</mat-label>
      <mat-select
        (selectionChange)="onActionStatusSelect($event)"
        [(ngModel)]="actionStatusId"
      >
        <!-- <mat-option value="All">All</mat-option> -->
        <mat-option
          *ngFor="let element of actionStatusNames"
          [value]="element.id"
        >
          {{ element.commonRefValue }}
        </mat-option>
      </mat-select>
    </mat-form-field>
    <mat-form-field appearance="outline" class="search-class ml-2">
      <mat-label>Select TransActionType</mat-label>
      <mat-select (selectionChange)="onTransActionTypeSelect($event)">
        <mat-option value="All">All</mat-option>
        <mat-option *ngFor="let element of transActionTypes" [value]="element">
          {{ element.commonRefValue }}
        </mat-option>
      </mat-select>
    </mat-form-field>
    <mat-form-field appearance="outline" class="search-class ml-2">
      <mat-label>Unit Belongs To</mat-label>
      <mat-select
        (selectionChange)="onUnitTypeBelongsChange($event)"
        [(ngModel)]="typeId"
      >
        <!-- <mat-option value="All">All</mat-option> -->
        <mat-option *ngFor="let element of companyType" [value]="element.id">
          {{ element.commonRefValue }}
        </mat-option>
      </mat-select>
    </mat-form-field>
  </div>
</div>
<div class="totals-summary-header">
  <div class="totals-summary-item">
    Total Received Payment:&nbsp;&nbsp;<span style="color: rgb(40, 178, 9)">{{
      formattedApprovedAmount
    }}</span>
  </div>
  <div class="totals-summary-item">
    Pending Payment Approval:&nbsp;&nbsp;<span
      style="color: rgba(60, 9, 178, 0.682)"
      >{{ formattedWaitingForApprovalAmount }}</span
    >
  </div>
  <div class="totals-summary-item">
    Total Received TDS:&nbsp;&nbsp;<span style="color: rgb(40, 178, 9)">{{
      approvedTdsAmount
    }}</span>
  </div>
  <div class="totals-summary-item">
    Pending TDS Approval:&nbsp;&nbsp;<span
      style="color: rgba(60, 9, 178, 0.682)"
      >{{ waitingForApprovalTdsAmount }}</span
    >
  </div>
</div>

<mat-card class="cmn-card">
  <mat-card-content class="cmn-card-content">
    <div class="tab-head">
      <table
        matSort
        mat-table
        [dataSource]="paymentLedger"
        class="mat-elevation-z8"
      >
        <ng-container matColumnDef="paymentReceiptCode">
          <th mat-header-cell *matHeaderCellDef>Receipt Code</th>
          <td mat-cell *matCellDef="let charge">
            {{ charge.paymentReceiptCode }}
          </td>
        </ng-container>

        <ng-container matColumnDef="customerName">
          <th mat-header-cell *matHeaderCellDef>Customer Name</th>
          <td mat-cell *matCellDef="let charge">
            {{ charge.applicantName }}
          </td>
        </ng-container>
        <ng-container matColumnDef="projectName">
          <th mat-header-cell *matHeaderCellDef>Project</th>
          <td mat-cell *matCellDef="let charge">
            {{ charge.projectName }}
          </td>
        </ng-container>
        <ng-container matColumnDef="unit">
          <th mat-header-cell *matHeaderCellDef>Unit</th>
          <td mat-cell *matCellDef="let charge">
            {{ charge.unitName }}
          </td>
        </ng-container>
        <ng-container matColumnDef="createdDate">
          <th mat-header-cell *matHeaderCellDef>Created Date</th>
          <td mat-cell *matCellDef="let charge">
            {{ charge.createdDate | date : "dd-MMM-yyyy" }}
          </td>
        </ng-container>
        <ng-container matColumnDef="paymentDate">
          <th mat-header-cell *matHeaderCellDef>Payment Date</th>
          <td mat-cell *matCellDef="let charge">
            {{ charge.paymentDate | date : "dd-MMM-yyyy" }}
          </td>
        </ng-container>
        <ng-container matColumnDef="paidAmount">
          <th mat-header-cell *matHeaderCellDef>Paid Amount</th>
          <td
            mat-cell
            *matCellDef="let charge"
            [ngClass]="getStatusClass(charge.actionStatus)"
          >
            {{ charge.formattedReceivedAmount }}
          </td>
        </ng-container>
        <!-- <ng-container matColumnDef="paidAmountForApproval">
          <th mat-header-cell *matHeaderCellDef>Paid Amount For Approval</th>
          <td
            mat-cell
            *matCellDef="let charge"
            [ngClass]="{
              pending:
                (charge.formattedPaidAmountForApproval &&
                  charge.formattedPaidAmountForApproval !== '₹0.00' &&
                  charge.formattedPaidAmountForApproval !== '₹0') ||
                (charge.formattedPaidTdsForApproval &&
                  charge.formattedPaidTdsForApproval !== '₹0.00' &&
                  charge.formattedPaidTdsForApproval !== '₹0')
            }"
          >
            {{ charge.formattedPaidAmountForApproval }}
          </td>
        </ng-container> -->

        <ng-container matColumnDef="referenceNumber">
          <th mat-header-cell *matHeaderCellDef>Reference Number</th>
          <td mat-cell *matCellDef="let charge" [matTooltip]="charge.referenceNumber ? charge.referenceNumber : 'N/A'">
            <span>{{ charge.referenceNumber ? getShortDescription(charge.referenceNumber) : "N/A" }}</span>
          </td>
        </ng-container>
        <ng-container matColumnDef="branchName">
          <th mat-header-cell *matHeaderCellDef>Branch Name</th>
          <td mat-cell *matCellDef="let charge">
            {{ charge.branchName || "N/A" }}
          </td>
        </ng-container>
        <ng-container matColumnDef="bankName">
          <th mat-header-cell *matHeaderCellDef>Bank Name</th>
          <td mat-cell *matCellDef="let charge">
            {{ charge.bankName }}
          </td>
        </ng-container>
        <ng-container matColumnDef="sourceName">
          <th mat-header-cell *matHeaderCellDef>Source</th>
          <td mat-cell *matCellDef="let charge">
            {{ charge.sourceName }}
          </td>
        </ng-container>
        <ng-container matColumnDef="paymentTypeName">
          <th mat-header-cell *matHeaderCellDef>Payment Type</th>
          <td mat-cell *matCellDef="let charge">
            {{ charge.paymentTypeName }}
          </td>
        </ng-container>

        <ng-container matColumnDef="approvedStatus">
          <th mat-header-cell *matHeaderCellDef>Approved Status</th>
          <td
            mat-cell
            *matCellDef="let charge"
            [ngClass]="getStatusClass(charge.actionStatus)"
          >
            {{ charge.actionStatus }}
          </td>
        </ng-container>
        <ng-container matColumnDef="transactionType">
          <th mat-header-cell *matHeaderCellDef>Transaction Type</th>
          <td mat-cell *matCellDef="let charge">
            {{ charge.transactionTypeName }}
          </td>
        </ng-container>
        <ng-container matColumnDef="landOwnerOrBuilder">
          <th mat-header-cell *matHeaderCellDef>Unit Belongs To</th>
          <td mat-cell *matCellDef="let charge">
            {{ charge.landOwnerOrBuilder }}
          </td>
        </ng-container>
        <ng-container matColumnDef="remarks">
          <th mat-header-cell *matHeaderCellDef>Remarks</th>
          <td
            mat-cell
            *matCellDef="let charge"
            [matTooltip]="charge.remarks ? charge.remarks : 'N/A'"
          >
            {{ charge.remarks ? getShortDescription(charge.remarks) : "N/A" }}
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let charge" class="mat-icon-actions">
            <mat-icon
              *ngIf="
                charge.actionStatus && charge.actionStatus.includes('Approved')
              "
              matTooltip="Generate Receipt"
              (click)="
                generatePaymentReceipt(
                  charge?.paymentLedgerId,
                  charge?.paymentReceiptUrl,
                  charge.projectName
                )
              "
              class="action-icon"
              >manage_history</mat-icon
            >
            <mat-icon
              *ngIf="charge.paymentReceiptUrl"
              matTooltip="Download Receipt"
              (click)="downloadPaymentReceipt(charge.paymentReceiptUrl)"
              class="action-icon"
              >download</mat-icon
            >
            <mat-icon
              matTooltip="View Receipt"
              (click)="viewDocument(charge.paymentReceiptUrl)"
              class="action-icon"
              *ngIf="charge.paymentReceiptUrl"
            >
              visibility
            </mat-icon>
            <mat-icon
              *ngIf="charge.actionStatus.includes('Waiting For Approval')"
              matTooltip="Edit Customer Payment"
              (click)="fetchPaymentLedgerByPaymentLedgerId(charge)"
              class="action-icon"
              >edit</mat-icon
            >
            <mat-menu #menu="matMenu" class="custom-menu">
              <button
                *ngIf="charge.emailUrl"
                mat-menu-item
                (click)="downloadDocuments('email', charge.emailUrl)"
              >
                <mat-icon class="menu-icon">email</mat-icon>
                <span class="menu-label">Download Email</span>
              </button>
              <button
                *ngIf="charge.emailUrl"
                mat-menu-item
                (click)="viewDocuments('email', charge.emailUrl)"
              >
                <mat-icon class="menu-icon"> visibility</mat-icon>
                <span class="menu-label">View email</span>
              </button>

              <button
                mat-menu-item
                *ngIf="charge.checkUrl"
                (click)="downloadDocuments('check', charge.checkUrl)"
              >
                <mat-icon class="menu-icon">file_download</mat-icon>
                <span class="menu-label">Download Slip</span>
              </button>
              <button
                *ngIf="charge.checkUrl"
                mat-menu-item
                (click)="viewDocuments('check', charge.checkUrl)"
              >
                <mat-icon class="menu-icon"> visibility</mat-icon>
                <span class="menu-label">View Slip</span>
              </button>

              <button
                mat-menu-item
                *ngIf="charge.challanaUrl"
                (click)="downloadDocuments('challan', charge.challanaUrl)"
              >
                <mat-icon class="menu-icon">description</mat-icon>
                <span class="menu-label">Download Challan</span>
              </button>
              <button
                *ngIf="charge.challanaUrl"
                mat-menu-item
                (click)="viewDocuments('challan', charge.challanaUrl)"
              >
                <mat-icon class="menu-icon"> visibility</mat-icon>
                <span class="menu-label">View Challan</span>
              </button>
            </mat-menu>
            <mat-icon
              [matMenuTriggerFor]="menu"
              matTooltip="Actions"
              class="action-trigger"
              *ngIf="charge.emailUrl || charge.checkUrl || charge.challanaUrl"
              >more_vert</mat-icon
            >
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr
          class="table-row"
          mat-row
          *matRowDef="let charge of paymentLedger; columns: displayedColumns"
        ></tr>
      </table>
    </div>
  </mat-card-content>
  <b>
    <hr style="margin: 0" />
  </b>
  <mat-card-footer class="pagination-sec">
    <mat-paginator
      [length]="totalItems"
      [pageSize]="pageSize"
      [pageSizeOptions]="pageSizeOptions"
      (page)="onPageChange($event)"
      showFirstLastButtons
      class="custom-paginator"
    ></mat-paginator>
  </mat-card-footer>
</mat-card>
